name: Lighthouse Performance Audit

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  build_deploy_and_audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build

      - name: Deploy to Firebase Preview Channel
        id: deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}"
          projectId: "sins-of-the-fathers"
          channelId: "pr-${{ github.event.pull_request.number }}"
          expires: "7d"

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI on Multiple Pages
        run: |
          PREVIEW_URL="${{ steps.deploy.outputs.details_url }}"

          PATHS=(
            "/"
            "/pages/characters.html"
            "/pages/timeline.html"
            "/pages/factions.html"
            "/pages/locations.html"
            "/pages/lore.html"
          )

          URL_LIST=""
          for path in "${PATHS[@]}"; do
            URL_LIST+="$PREVIEW_URL$path,"
          done

          lhci autorun --config=./.lighthouserc.json --urls ${URL_LIST%,} || echo "Lighthouse finished with potential errors but we proceed."
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
