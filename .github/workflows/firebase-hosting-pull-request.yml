# This file was auto-generated by the Firebase CLI (ve Lighthouse CI için güncellendi)

name: Deploy to Firebase Hosting on PR
on: pull_request
permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Proje Build Adımları
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Kullandığınız Node versiyonuna göre değiştirin
      - name: Install Dependencies
        run: npm ci # veya npm install
      - name: Build Project
        run: npm run build # Varsa build komutunuz

      # 1. Firebase Preview Dağıtımı (URL'i Yakalama)
      - name: Deploy to Firebase Preview Channel
        id: deploy # Lighthouse'a URL çıktısı için bu ID'yi kullanacağız
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: sins-of-the-fathers
      
      # 2. Lighthouse CI Kurulumu
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      # 3. Dinamik URL'leri Oluşturma ve Lighthouse'ı Çalıştırma
      - name: Run Lighthouse CI on Preview URL
        run: |
          # Firebase Deploy adımından Preview URL'i yakala
          # outputs.details_url Firebase Action'ın standart çıktısıdır
          PREVIEW_URL="${{ steps.deploy.outputs.details_url }}"
          
          # Sitemap'inizdeki kritik sayfaların yolları
          PATHS=(
            "/"
            "/pages/characters.html"
            "/pages/timeline.html"
            "/pages/factions.html"
            "/pages/locations.html"
            "/pages/lore.html"
          )
          
          # Dinamik URL listesini oluştur
          URL_LIST=""
          for path in "${PATHS[@]}"; do
            URL_LIST+="$PREVIEW_URL$path," 
          done
          
          # Lighthouse CI'ı lighthouserc.json konfigürasyonu ile çalıştır
          # --urls komutu ile test edilecek URL'leri besliyoruz
          # ${URL_LIST%,} ile sondaki virgülü kaldırıyoruz
          lhci autorun --urls ${URL_LIST%,}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}