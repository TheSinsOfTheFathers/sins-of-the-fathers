---
import { createClient } from "@sanity/client";
import { urlFor } from "../../lib/urlFor";
import { PortableText } from "astro-portabletext";
import BaseLayout from "../../layouts/BaseLayout.astro";

interface Post {
  title: string;
  publishedAt: string;
  mainImage: any;
  body: any;
  authorName?: string;
}

interface Props {
  post: Post;
}

export async function getStaticPaths() {
  const client = createClient({
    projectId: "8cfeoaz2", 
    dataset: "production",
    useCdn: true,
    apiVersion: "2023-05-03",
  });

  const posts = await client.fetch(`*[_type == "post" && defined(slug.current)]{
    "slug": slug.current,
    title,
    publishedAt,
    mainImage,
    body,
    authorName 
  }`);

  return posts.map((post: Post) => ({
    params: { slug: (post as any).slug },
    props: { post },
  }));
}

// 2. Props'u artık güvenle alabiliriz
const { post } = Astro.props as Props;

function formatDate(dateString: string) {
  if (!dateString) return 'Undated Record';
  return new Date(dateString).toLocaleDateString('en-US', { 
    year: "numeric", month: "long", day: "numeric"
  });
}
---

<BaseLayout title={post.title}>
    <div class="max-w-3xl mx-auto px-6 py-12">
      <div class="flex items-center gap-4 mb-6 text-xs font-mono text-[#c5a059] uppercase tracking-widest">
        <span>{formatDate(post.publishedAt)}</span>
        <span class="text-gray-700">|</span>
        <span class="text-white">CLEARANCE: OPEN</span>
      </div>

      <h1 class="text-3xl md:text-5xl font-serif text-white mb-8 leading-tight">
        {post.title}
      </h1>

      {post.mainImage && (
        <div class="relative w-full aspect-video mb-12 border border-white/10 overflow-hidden group">
          <img 
            src={urlFor(post.mainImage).width(1200).height(675).url()} 
            alt={post.title}
            class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-1000"
          />
          <div class="absolute inset-0 shadow-inner bg-linear-to-t from-[#050505] to-transparent opacity-60"></div>
        </div>
      )}

      <article class="prose prose-invert prose-lg max-w-none font-sans font-light text-gray-400">
        <div class="space-y-6 leading-relaxed">
            <PortableText value={post.body} />
        </div>
      </article>

      <div class="mt-16 pt-8 border-t border-white/10 flex items-center gap-4">
        <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-[#c5a059] font-serif border border-[#c5a059]">A</div>
        <div>
            <p class="text-xs text-gray-200 font-mono uppercase">REPORT PREPARER</p>
            <p class="text-white font-serif tracking-wide">{post.authorName || 'Unknown Agent'}</p>
        </div>
      </div>
    </div>
</BaseLayout>