import{c as v}from"./sanityClient-DzZXYHaN.js";import l from"https://esm.sh/i18next@23.7.6";import"https://esm.sh/i18next-http-backend@2.4.1";import"https://esm.sh/i18next-browser-languagedetector@7.2.0";import{i as T}from"./seo-DYcZ_Lxp.js";import{g as p}from"./main-CoGTBBld.js";import"https://esm.sh/@sanity/client@6.22.0";import"https://esm.sh/@sanity/image-url@1.1.0";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";let h=null;const u={"ballantine-empire":{border:"#c5a059",fill:"#c5a059",glow:"#ffd700"},"macpherson-clan":{border:"#7f1d1d",fill:"#991b1b",glow:"#ef4444"},default:{border:"#52525b",fill:"#3f3f46",glow:"#d4d4d8"}},k=e=>{const o=document.getElementById(e);h&&(h.off(),h.remove(),h=null),o&&(o._leaflet_id=null,o.innerHTML="",p.set(o,{clearProps:"all"}))};async function _(e){try{const o=e.replace("/public",""),t=await fetch(o);if(!t.ok)throw new Error(`HTTP ${t.status}`);return await t.json()}catch(o){return console.warn(`Map Layer Error (${e}):`,o),null}}const M=(e,o="fa-map-marker-alt")=>{if(!window.L)return null;const n=(u[e]||u.default).border;return L.divIcon({className:"custom-tactical-icon",html:`
            <div class='relative flex items-center justify-center w-8 h-8 group cursor-pointer'>
                <div class="absolute inset-0 rounded-full border border-current opacity-60 animate-spin-slow" style="color:${n}"></div>
                <div class='flex items-center justify-center w-5 h-5 rounded-full bg-obsidian border border-current shadow-[0_0_10px_currentColor]' 
                     style="color:${n}; background-color:rgba(0,0,0,0.7); border-color:${n}">
                    <i class="fas ${o} text-[9px]"></i>
                </div>
                <div class="absolute inset-0 rounded-full bg-current opacity-20 animate-ping pointer-events-none" style="color:${n}"></div>
            </div>
        `,iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[0,-16]})},S=(e,o)=>{!o||o.length===0||(console.log(`> Deploying ${o.length} tactical markers...`),o.forEach(t=>{const n=t.location?.lat||t.coordinates?.lat,r=t.location?.lng||t.coordinates?.lng;if(!n||!r)return;const i=t.faction?.slug?.current||"default",m=(u[i]||u.default).border,f=M(i,"fa-crosshairs"),c=L.marker([n,r],{icon:f}).addTo(e),d=c.getElement();d&&p.set(d,{scale:0,opacity:0}),c.on("popupopen",function(y){const g=this.getPopup().getElement();if(g){const a=g.querySelector(".leaflet-popup-content");a&&p.fromTo(a,{y:10,opacity:0},{y:0,opacity:1,duration:.3})}}),c.bindPopup(`
            <div class="text-left min-w-[200px] font-sans">
                <h3 style="color:${m}" class="font-serif text-lg border-b border-gray-700 pb-1 mb-2 uppercase tracking-wide">
                    ${t.name}
                </h3>
                <div class="text-xs font-mono text-gray-400 space-y-1 mb-3">
                    <p>${l.t("locations.sector")}: <span class="text-white">${i.split("-")[0].toUpperCase()}</span></p>
                    <p class="line-clamp-2 opacity-80">${t.summary||l.t("locations.default_summary")}</p>
                </div>
                <a href="location-detail.html?slug=${t.slug}" 
                   class="block text-center border border-white/20 bg-white/5 hover:bg-white/10 py-2 text-[10px] text-white font-mono uppercase tracking-widest transition-colors">
                    > ${l.t("locations.access_terminal")}
                </a>
            </div>
        `,{className:"leaflet-dark-popup"})}))},C=async(e,o)=>{if(!o)return;const t={"ballantine-empire":["/assets/maps/united-kingdom-border.geojson","/assets/maps/california-border.geojson","/assets/maps/italy-border.geojson"],"macpherson-clan":["/assets/maps/scotland-highlands.geojson"]};for(const n of o){const r=n.slug.current,i=t[r];if(!i)continue;const m=u[r]||u.default,f={color:m.border,weight:1,opacity:.8,fillColor:m.fill,fillOpacity:.15,dashArray:"5, 10",className:"tactical-overlay-path"};for(const c of i){const d=await _(c);d&&L.geoJSON(d,{style:f}).addTo(e)}}};async function q(){const e=document.getElementById("map"),o=document.getElementById("map-loader");e&&p.set(e,{opacity:0,scale:.95});try{const t={"@context":"https://schema.org","@type":"Map",name:"Global Surveillance Map | The Sins of the Fathers",description:"Interactive map showing all faction territories and key locations in the TSOF universe.",url:window.location.href};T(t)}catch(t){console.warn("Schema Injection Failed:",t)}if(e){if(!window.L){console.error("Leaflet Library Missing!"),o&&(o.innerHTML="<span class='text-red-500'>OFFLINE</span>");return}try{let i=function(a){const s=document.getElementById("location-name-display");if(s){const b="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let w=0;const $=setInterval(()=>{s.textContent=a.split("").map((I,x)=>x<w?a[x]:b[Math.floor(Math.random()*b.length)]).join(""),w>=a.length&&clearInterval($),w+=1/2},30);s.classList.add("text-gold"),setTimeout(()=>s.classList.remove("text-gold"),1e3)}};k("map");const t=L.map("map",{center:[40,-30],zoom:3,zoomControl:!1,attributionControl:!1});h=t,t.getPane("popupPane").style.zIndex=800;const r=L.control.zoom({position:"topright"}).addTo(t).getContainer();r&&p.set(r,{autoAlpha:0,x:50}),L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19}).addTo(t),window.zoomToLocation=(a,s,b)=>{t.flyTo([a,s],b,{duration:2.5}),i(`${l.t("locations.hud_coords_locked")}: ${a} / ${s}`)},window.resetMap=()=>{t.flyTo([40,-30],3,{duration:2}),i(l.t("locations.hud_global_view"))};const m=`*[_type == "location"]{ 
            name, "slug": slug.current, location, coordinates, summary, faction->{slug}
        }`,f='*[_type == "faction"]{ name, slug }',[c,d]=await Promise.all([v.fetch(m),v.fetch(f)]);await C(t,d),S(t,c),t.on("mousemove",a=>{const s=document.getElementById("coordinates-display");s&&(s.textContent=`${l.t("locations.hud_lat")}: ${a.latlng.lat.toFixed(4)} // ${l.t("locations.hud_lng")}: ${a.latlng.lng.toFixed(4)}`)});const y=p.timeline();o&&y.to(o,{autoAlpha:0,duration:.5,onComplete:()=>o.style.display="none"}),y.to(e,{opacity:1,scale:1,duration:1.5,ease:"power2.inOut"},"-=0.2"),r&&y.to(r,{autoAlpha:1,x:0,duration:.5},"-=0.5");const g=document.querySelectorAll(".custom-tactical-icon");g.length>0&&y.to(g,{scale:1,opacity:1,duration:.6,stagger:{amount:1.5,from:"random"},ease:"back.out(2)"},"-=0.8")}catch(t){console.error("System Failure (Map):",t),e.innerHTML=`<div class="flex h-full items-center justify-center text-red-500 font-mono">${l.t("locations.error_uplink")}</div>`,o&&(o.style.display="none"),p.to(e,{opacity:1})}}}export{q as displayLocations};
