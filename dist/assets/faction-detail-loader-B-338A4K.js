import{c as x}from"./sanityClient-DzZXYHaN.js";import{toHTML as _}from"https://esm.sh/@portabletext/to-html@2.0.13";import"https://esm.sh/blurhash@2.0.5";import r from"https://esm.sh/i18next@23.7.6";import"https://esm.sh/i18next-http-backend@2.4.1";import"https://esm.sh/i18next-browser-languagedetector@7.2.0";import{i as v}from"./seo-DYcZ_Lxp.js";import{g as c}from"./main-CoGTBBld.js";import"https://esm.sh/@sanity/client@6.22.0";import"https://esm.sh/@sanity/image-url@1.1.0";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";const w=(t,e,i,l="mini-map")=>{if(!window.L||!document.getElementById(l))return;const d=document.getElementById(l);d._leaflet_id&&(d.innerHTML="",d._leaflet_id=null);const m=L.map(l,{center:[t,e],zoom:11,zoomControl:!1,attributionControl:!1,dragging:!1,scrollWheelZoom:!1,doubleClickZoom:!1,boxZoom:!1,keyboard:!1});L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19}).addTo(m);const p=L.divIcon({className:"radar-ping",html:`
            <div class="relative w-4 h-4 flex items-center justify-center">
                <div class="absolute w-full h-full rounded-full animate-ping opacity-75" style="background-color: ${i}"></div>
                <div class="absolute w-2 h-2 rounded-full shadow-[0_0_10px_${i}]" style="background-color: ${i}"></div>
            </div>
        `,iconSize:[20,20],iconAnchor:[10,10]});L.marker([t,e],{icon:p}).addTo(m),c.from(d,{opacity:0,scale:.9,duration:1,ease:"power2.out"})},C=(t,e)=>{const i=t||"#c5a059";document.documentElement.style.setProperty("--theme-color",i);const l=document.getElementById("faction-banner");return l&&e&&(l.style.backgroundImage=`url('${e}')`,c.fromTo(l,{opacity:0,scale:1.1},{opacity:1,scale:1,duration:2,ease:"power2.out"})),i},$=t=>{const e={title:document.getElementById("faction-title"),subtitle:document.getElementById("faction-subtitle"),leader:document.getElementById("faction-leader"),hq:document.getElementById("faction-hq"),description:document.getElementById("faction-description"),iconContainer:document.getElementById("faction-icon-container"),roster:document.getElementById("faction-roster"),threat:document.getElementById("threat-text"),relations:document.getElementById("faction-locations-list"),mainGrid:document.querySelector("main"),sidebar:document.querySelector(".lg\\:col-span-1 > div")},i=t.title||"Unknown Faction";document.title=r.t("faction_detail_loader.meta_title",{factionName:i});try{const o=t.description?t.description.map(s=>s.children?.map(n=>n.text).join("")).join(" "):t.motto||"",a={"@context":"https://schema.org","@type":"Organization",name:i,slogan:t.motto,description:o.substring(0,160)+"...",url:window.location.href,logo:t.image?.asset?.url,founder:t.leader?{"@type":"Person",name:t.leader.name}:void 0,location:t.hqName?{"@type":"Place",name:t.hqName}:void 0};v(a)}catch(o){console.warn("SEO Warning:",o)}e.title&&(e.title.textContent=i),e.subtitle&&(e.subtitle.textContent=t.motto?`"${t.motto}"`:r.t("faction_detail_loader.motto_redacted"));const d=(t.type||"syndicate")==="syndicate"?'<i class="fas fa-skull-crossbones"></i>':'<i class="fas fa-chess-king"></i>';e.iconContainer&&(e.iconContainer.innerHTML=d);const m=C(t.color?.hex,t.image?.asset?.url);if(t.hqLocation?.lat&&t.hqLocation?.lng&&setTimeout(()=>w(t.hqLocation.lat,t.hqLocation.lng,m),800),e.leader){const o=t.leader?t.leader.name:r.t("faction_detail_loader.unknown_leader"),a=t.leader?t.leader.slug:null;e.leader.innerHTML=`<span>${o}</span>${a?`<a href="character-detail.html?slug=${a}" title="${r.t("faction_detail_loader.view_profile")}"><i class="fas fa-external-link-alt text-xs opacity-50 hover:opacity-100"></i></a>`:""}`}if(e.hq&&(e.hq.textContent=t.hqName||r.t("faction_detail_loader.encrypted_coords")),e.threat){const o=(t.threatLevel||"unknown").toLowerCase(),a=e.threat.parentElement,s={minimal:{text:"MINIMAL",bars:1,color:"text-cyan-400",barColor:"bg-cyan-400"},low:{text:"LOW",bars:2,color:"text-green-400",barColor:"bg-green-400"},medium:{text:"MEDIUM",bars:3,color:"text-yellow-400",barColor:"bg-yellow-400"},high:{text:"HIGH",bars:4,color:"text-orange-500",barColor:"bg-orange-500"},critical:{text:"CRITICAL",bars:5,color:"text-gold",barColor:"bg-gold"},extreme:{text:"EXTREME",bars:6,color:"text-red-500",barColor:"bg-red-500"},unknown:{text:r.t("faction_detail_loader.threat_analyzing"),bars:0,color:"text-gray-500",barColor:"bg-gray-800"}},n=s[o]||s.unknown;e.threat.textContent=n.text,e.threat.className=`ml-2 font-bold font-mono text-xs ${n.color}`;const u=a.querySelectorAll(".threat-bar");u.forEach(g=>g.className="threat-bar w-2 h-6 bg-gray-800");const b=Array.from(u).slice(0,n.bars);c.to(b,{duration:.1,stagger:.1,onStart:function(){this.targets().forEach(g=>{g.classList.remove("bg-gray-800"),g.classList.add(n.barColor)})}}),n.bars>=5&&c.to(b,{opacity:.5,duration:.5,repeat:-1,yoyo:!0})}if(e.description&&(t.description?e.description.innerHTML=_(t.description,{components:{block:{normal:({children:o})=>`<p class="mb-4 opacity-90">${o}</p>`,h2:({children:o})=>`<h3 class="text-xl text-white mt-6 mb-2 font-serif border-b border-white/10 pb-1">${o}</h3>`}}}):e.description.innerHTML=`<p class="text-gray-500 italic font-mono">${r.t("faction_detail_loader.no_records_available")}</p>`),e.roster&&(t.members&&t.members.length>0?e.roster.innerHTML=t.members.map(o=>{const a=o.imageUrl||`https://ui-avatars.com/api/?background=1a1a1a&color=888&name=${encodeURIComponent(o.name||"User")}`;return`
                    <a href="character-detail.html?slug=${o.slug}" class="gsap-roster-card opacity-0 roster-card bg-white/5 p-3 border border-white/5 flex items-center space-x-3 hover:bg-white/10 transition-all group">
                        <div class="w-10 h-10 bg-black overflow-hidden rounded-full border border-white/10 group-hover:border-[var(--theme-color)] transition-colors">
                            <img src="${a}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                        </div>
                        <div>
                            <h4 class="font-serif text-gray-200 leading-tight group-hover:text-white text-sm">${o.name}</h4>
                            <p class="text-[9px] text-gray-500 font-mono uppercase tracking-wider group-hover:text-[var(--theme-color)]">${o.role||"Member"}</p>
                        </div>
                    </a>`}).join(""):e.roster.innerHTML=`<div class="text-xs font-mono text-gray-600 col-span-full py-4 text-center border border-dashed border-gray-800">${r.t("faction_detail_loader.roster_empty")}</div>`),e.relations){const o=e.relations.previousElementSibling;o&&(o.textContent=r.t("faction_detail_loader.foreign_relations")),t.relations&&t.relations.length>0?e.relations.innerHTML=t.relations.map(s=>{let n="text-gray-500",u="fa-minus";return s.status==="hostile"&&(n="text-red-500",u="fa-times"),s.status==="ally"&&(n="text-green-500",u="fa-handshake"),s.status==="vassal"&&(n="text-blue-400",u="fa-link"),`
                    <div class="gsap-relation-item opacity-0 flex justify-between items-center text-xs border-b border-white/5 pb-2 last:border-0 group cursor-help" title="${s.description||"No notes"}">
                        <span class="text-gray-300 group-hover:text-white transition-colors">${s.targetName}</span>
                        <span class="font-mono ${n} uppercase flex items-center gap-1">
                            <i class="fas ${u} text-[9px]"></i> ${s.status}
                        </span>
                    </div>
                `}).join(""):e.relations.innerHTML=`<div class="text-xs text-gray-600 font-mono text-center py-2">${r.t("faction_detail_loader.no_diplomatic_records")}</div>`;const a=e.relations.parentElement.querySelector("button");a&&(a.innerText=r.t("faction_detail_loader.access_global_map"),a.onclick=()=>window.location.href="locations.html")}e.mainGrid&&e.mainGrid.classList.remove("opacity-0");const p=c.timeline({defaults:{ease:"power3.out"}}),f=[e.title,e.subtitle,e.iconContainer].filter(o=>o);f.length>0&&p.from(f,{x:-50,opacity:0,duration:1,stagger:.1}),e.sidebar&&p.from(e.sidebar,{x:-20,opacity:0,duration:.6},"-=0.5"),e.description&&p.from(e.description,{y:20,opacity:0,duration:.8},"-=0.4");const h=document.querySelectorAll(".gsap-roster-card");h.length>0&&p.to(h,{opacity:1,y:0,scale:1,startAt:{y:20,scale:.95},stagger:.1,duration:.5},"-=0.2");const y=document.querySelectorAll(".gsap-relation-item");y.length>0&&p.to(y,{opacity:1,x:0,startAt:{x:-10},stagger:.05,duration:.4},"<")},P=async()=>{const t=document.getElementById("factions-loader"),e=document.querySelector("main"),l=new URLSearchParams(window.location.search).get("slug");if(e&&c.set(e,{opacity:0}),!l){t&&(t.innerHTML=`<p class="text-red-500 font-mono text-sm">${r.t("faction_detail_loader.error_missing_slug")}</p>`),e&&c.to(e,{opacity:1});return}try{const m=await x.fetch(`*[_type == "faction" && slug.current == $slug][0]{
            title, motto, description, type, threatLevel,
            "hqName": hq, 
            "hqLocation": hqLocation,
            "color": color,
            image { asset->{ url, "blurHash": metadata.blurHash } },
            leader->{ name, "slug": slug.current },
            "members": *[_type == "character" && references(^._id)] | order(name asc) [0...6] {
                name, "slug": slug.current, title, "role": title, 
                "imageUrl": image.asset->url
            },
            relations[] {
                status, description, "targetName": target->title
            }
        }`,{slug:l});t&&c.to(t,{opacity:0,duration:.5,onComplete:()=>t.style.display="none"}),m?(c.to(e,{opacity:1,duration:.5}),$(m)):e&&(e.innerHTML=`<div class="h-[50vh] flex flex-col items-center justify-center text-red-800 font-mono"><span>${r.t("faction_detail_loader.error_file_corrupted")}</span></div>`,c.to(e,{opacity:1}))}catch(d){console.error("Intel Failure:",d),e&&(e.innerHTML=`<div class="h-[50vh] flex items-center justify-center text-red-500 font-mono">${r.t("faction_detail_loader.error_system_malfunction")}</div>`,c.to(e,{opacity:1}))}};export{P as loadFactionDetails};
