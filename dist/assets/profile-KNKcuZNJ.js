import{a as h,d as A,s as D}from"./main-CoGTBBld.js";import{onAuthStateChanged as U,updateProfile as T,deleteUser as x}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{doc as B,getDoc as S,setDoc as N,serverTimestamp as P,deleteDoc as C}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{ref as q,uploadBytes as k,getDownloadURL as F}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import"https://esm.sh/i18next@23.7.6";import"https://esm.sh/i18next-http-backend@2.4.1";import"https://esm.sh/i18next-browser-languagedetector@7.2.0";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";function w(t,c,r="default"){t.innerText=c,r==="loading"?t.classList.add("opacity-70","cursor-wait"):r==="success"?(t.classList.remove("bg-gold","text-black"),t.classList.add("bg-green-600","text-white"),setTimeout(()=>{t.innerText="UPDATE RECORDS",t.classList.remove("bg-green-600","text-white"),t.classList.add("bg-gold","text-black")},3e3)):r==="error"&&(t.classList.add("bg-red-900","text-white"),setTimeout(()=>{t.innerText="UPDATE RECORDS",t.classList.remove("bg-red-900","text-white")},3e3))}async function M(){const t=document.getElementById("profile-content"),c=document.getElementById("profile-loader"),r=document.getElementById("display-name"),L=document.getElementById("user-email"),s=document.querySelector("textarea"),E=document.querySelectorAll('input[name="faction"]'),l=document.getElementById("profile-form"),f=l?l.querySelector('button[type="submit"]'):null,d=document.getElementById("profile-image-preview"),u=document.getElementById("profile-photo-input");document.querySelector("#auth-signout-btn"),t&&U(h,async i=>{if(!i){window.location.href="/pages/login.html?redirect=profile";return}console.log(`> Accessing File: ${i.uid}`);const p=B(A,"users",i.uid);let a={};try{const e=await S(p);e.exists()&&(a=e.data())}catch(e){console.error("Failed to decrypt user profile",e)}L&&(L.value=i.email),r&&(r.value=i.displayName||a.displayName||""),s&&a.bio&&(s.value=a.bio);const v=i.photoURL||a.photoURL;v&&d&&(d.src=v),a.faction&&E.forEach(e=>{e.value===a.faction&&(e.checked=!0)}),c&&setTimeout(()=>{c.classList.add("opacity-0","pointer-events-none"),t.classList.remove("opacity-0")},600),u&&d&&u.addEventListener("change",e=>{const n=e.target.files&&e.target.files[0];if(!n)return;if(n.size>2*1024*1024){alert("Image file too large. Compress data packet.");return}const g=URL.createObjectURL(n);d.src=g}),l&&l.addEventListener("submit",async e=>{e.preventDefault(),w(f,"ENCRYPTING DATA...","loading");const n=r.value.trim(),g=s?s.value.trim():"";let R=null;E.forEach(o=>{o.checked&&(R=o.value)});const y=u&&u.files[0];try{let o=i.photoURL;if(y){const b=q(D,`avatars/${i.uid}/${Date.now()}_${y.name}`);await k(b,y),o=await F(b)}h.currentUser&&await T(h.currentUser,{displayName:n,photoURL:o}),await N(p,{displayName:n,photoURL:o,bio:g,faction:R||"neutral",updatedAt:P()},{merge:!0}),console.log("> Profile Updated Successfully"),w(f,"ACCESS GRANTED","success");const I=document.querySelector("#user-menu-btn img");I&&o&&(I.src=o)}catch(o){console.error("> Update Failed:",o),w(f,"UPLOAD FAILED","error")}});const m=document.querySelector(".lg\\:col-span-4 button");m&&!m.hasAttribute("data-listening")&&(m.setAttribute("data-listening","true"),m.addEventListener("click",async()=>{if(confirm("WARNING: This action will permanently scrub your identity from the Ballantine Archives. This cannot be undone. Proceed?"))try{await C(p),await x(i),alert("Identity scorched. Redirecting..."),window.location.href="/index.html"}catch(e){console.error(e),alert("Error: Clearance insufficient. Re-login required.")}}))})}export{M as default,M as loadProfilePage};
